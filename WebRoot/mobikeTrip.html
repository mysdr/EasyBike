<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<title>后台模板</title>
<link rel="stylesheet" href="assets/css/amazeui.css" />
<link rel="stylesheet" href="assets/css/core.css" />
<link rel="stylesheet" href="assets/css/menu.css" />
<link rel="stylesheet" href="assets/css/index.css" />
<link rel="stylesheet" href="assets/css/admin.css" />
<link rel="stylesheet" href="assets/css/page/typography.css" />
<link rel="stylesheet" href="assets/css/page/form.css" />
<link rel="stylesheet" href="assets/css/component.css" />

</head>
<body>
	<!-- Begin page -->
	<header class="am-topbar am-topbar-fixed-top">
		<div class="am-topbar-left am-hide-sm-only">
			<a href="index.html" class="logo"><span>Easy<span>Bike</span>
			</span><i class="zmdi zmdi-layers"></i> </a>
		</div>

		<div class="contain">
			<ul class="am-nav am-navbar-nav am-navbar-left">

				<li><h4 class="page-title">mobike单车移动轨迹</h4></li>
			</ul>

			<ul class="am-nav am-navbar-nav am-navbar-right">
				<li class="inform"><i class="am-icon-bell-o" aria-hidden="true"></i>
				</li>
				<li class="hidden-xs am-hide-sm-only">
					<form role="search" class="app-search">
						<input type="text" placeholder="Search..." class="form-control">
						<a href=""><img src="assets/img/search.png"> </a>
					</form>
				</li>
			</ul>
		</div>
	</header>
	<!-- end page -->


	<div class="admin">
		<!--<div class="am-g">-->
		<!-- ========== Left Sidebar Start ========== -->
		<!--<div class="left side-menu am-hide-sm-only am-u-md-1 am-padding-0">
			<div class="slimScrollDiv" style="position: relative; overflow: hidden; width: auto; height: 548px;">
				<div class="sidebar-inner slimscrollleft" style="overflow: hidden; width: auto; height: 548px;">-->
		<!-- sidebar start -->
		<div class="admin-sidebar am-offcanvas  am-padding-0"
			id="admin-offcanvas" style="overflow-y: hidden;">
			<div class="am-offcanvas-bar admin-offcanvas-bar">
				<!-- User -->
				<div class="user-box am-hide-sm-only">
					<div class="user-img">
						<img src="assets/img/avatar-1.jpg" alt="user-img"
							title="Mat Helme" class="img-circle img-thumbnail img-responsive">
						<div class="user-status offline">
							<i class="am-icon-dot-circle-o" aria-hidden="true"></i>
						</div>
					</div>
					<h5>
						<a href="#">管理员</a>
					</h5>
					<ul class="list-inline">
						<li><a href="#"> <i class="fa fa-cog" aria-hidden="true"></i>
						</a></li>

						<li><a href="#" class="text-custom"> <i class="fa fa-cog"
								aria-hidden="true"></i>
						</a></li>
					</ul>
				</div>
				<!-- End User -->
				<ul class="am-list admin-sidebar-list">
					<li><a href="index.html"><span class="am-icon-home"></span>
							首页</a></li>
					<li class="admin-parent"><a class="am-cf"
						data-am-collapse="{target: '#collapse-nav1'}"><span
							class="am-icon-line-chart"></span> 单车管理 <span
							class="am-icon-angle-right am-fr am-margin-right"></span> </a>
						<ul class="am-list am-collapse admin-sidebar-sub am-in"
							id="collapse-nav1">
							<li><a href="BikeManage.html" class="am-cf"> 单车位置 </a></li>
							<li><a href="TraceManage.html">轨迹管理</a></li>
						</ul></li>
					<li class="admin-parent"><a class="am-cf"
						data-am-collapse="{target: '#collapse-nav2'}"><span
							class="am-icon-line-chart"></span> 用户管理 <span
							class="am-icon-angle-right am-fr am-margin-right"></span> </a>
						<ul class="am-list am-collapse admin-sidebar-sub am-in"
							id="collapse-nav2">
							<li><a href="UserStatistics.html" class="am-cf"> 统计信息 </a></li>
							<li><a href="UserManage.html">用户列表</a></li>
						</ul></li>
					<li><a href="RepairManage.html"><span class="am-icon-file"></span>
							维修管理</a></li>
					<li><a href="mobikeAnalysis.html"><span
							class="am-icon-file"></span> 摩拜单车数据分析</a></li>
					<li><a href="AccusationManage.html"><span
							class="am-icon-file"></span> 举报管理</a></li>
				</ul>
			</div>
		</div>
		<!-- sidebar end -->

		<!--</div>
			</div>
		</div>-->
		<!-- ========== Left Sidebar end ========== -->



		<!--	<div class="am-g">-->
		<!-- ============================================================== -->
		<!-- Start right Content here -->
		<div class="content-page">
			<!-- Start content -->
			<div class="content">

				<div class="card-box">
					<div class="am-g">
						<!-- Row start -->
						<div class="am-u-md-12">
							<div id="mapContainer" style="width:100%; height:500px"></div>
						</div>
					</div>
					<!-- Row end -->
				</div>

				<div class="card-box">
					<!-- Row start -->
					<div class="am-g">
						<div class="am-u-md-12">
							<div class="am-btn-toolbar">
								<div class="am-btn-group am-btn-group-xs">
									<button onclick="showAllTrip()" type="button"
										class="am-btn am-btn-default">
										<span class="am-icon-archive"></span> 全部显示
									</button>
								</div>
							</div>
						</div>

						<div class="am-u-sm-12 am-u-md-3">
							<div class="am-input-group am-input-group-sm">
								<input type="text" class="am-form-field"> <span
									class="am-input-group-btn">
									<button class="am-btn am-btn-default" type="button">搜索</button>
								</span>
							</div>
						</div>
					</div>
					<!-- Row end -->

					<!-- Row start -->
					<div class="am-g">
						<div class="am-u-sm-12">
							<form class="am-form">

								<table
									class="am-table am-table-striped am-table-hover table-main">
									<thead>
										<tr>
											<th class="table-id">ID</th>
											<th class="table-type">单车号</th>
											<th class="table-type">单车类型</th>
											<th class="table-author am-hide-sm-only">起始位置</th>
											<th class="table-author am-hide-sm-only">结束位置</th>
											<th class="table-author am-hide-sm-only">起始时间</th>
											<th class="table-author am-hide-sm-only">结束时间</th>
											<th class="table-date am-hide-sm-only">总长</th>
											<th class="table-set">操作</th>
										</tr>
									</thead>
									<tbody id="usertbody">

									</tbody>
								</table>
								<hr />
								<p>注：由于爬虫性能以及统计方式问题，数据存在误差，时间误差在10分钟左右。</p>
							</form>

						</div>
						<!-- Row end -->
					</div>
				</div>
			</div>
		</div>
		<!-- end right Content here -->

		<!-- navbar -->
		<a href="admin-offcanvas"
			class="am-icon-btn am-icon-th-list am-show-sm-only admin-menu"
			data-am-offcanvas="{target: '#admin-offcanvas'}"> <!--<i class="fa fa-bars" aria-hidden="true"></i>-->
		</a>

		<script type="text/javascript" src="assets/js/jquery-2.1.0.js"></script>
		<script type="text/javascript" src="assets/js/amazeui.min.js"></script>
		<script type="text/javascript" src="assets/js/app.js"></script>
		<script type="text/javascript" src="assets/js/blockUI.js"></script>
		<script type="text/javascript" src="assets/js/charts/echarts.min.js"></script>
		<script type="text/javascript" src="assets/js/charts/indexChart.js"></script>
		<script type="text/javascript" src="assets/js/layer.js"></script>

		<script type="text/javascript"
			src="http://webapi.amap.com/maps?v=1.3&key=bef6d4f09241ab4cd125beaedf2ff028&plugin=AMap.AdvancedInfoWindow"></script>
		<!--引入UI组件库（1.0版本） -->
		<script src="//webapi.amap.com/ui/1.0/main.js"></script>

		<script type="text/javascript">
			var map;
			var trips = new Array();
			function init() {
				map = new AMap.Map('mapContainer', {
					resizeEnable : true,
					zoom : 16,
					center : [ 121.403316, 31.229611 ]
				});
				map.plugin([ "AMap.ToolBar" ], function() {
					map.addControl(new AMap.ToolBar());
				});
			}
		
			$(window)
				.on(
					'load',
					function() {
						init();
						initTable();
					});
		</script>
		<script type="text/javascript">
			function initTable() {
				$
					.ajax({
						url : "http://localhost:8080/easybike/restful/bike/getMobikeTripById",
						type : "post",
						dataType : "json",
						data : {
							"bikeID" : GetRequest()["userid"]
						},
						success : function(result) {
							var r = result;
							var obj = r.obj;
							var retcode = r.retcode;
							var errorMsg = r.errorMsg;
							if (retcode != "0000") {
								layer.alert(errorMsg);return;
							}
							$.each(obj, function(index, item) {
								trips.push(new AMap.LngLat(parseFloat(item.startlon), parseFloat(item.startlat)));
								trips.push(new AMap.LngLat(parseFloat(item.endlon), parseFloat(item.endlat)));
								var shtml = "<tr onclick='showTrace(" + item.id + ");'><td class='am-hide-sm-only'>" + item.id + "</td>"
									+ "<td class='am-hide-sm-only'>" + item.bikeid + "</td>"
									+ "<td class='am-hide-sm-only'>" + GetRequest()["biketype"] + "</td>"
									+ "<td class='am-hide-sm-only'>" + "(" + item.startlon.substr(0, 8) + "," + item.startlat.substr(0, 8) + ") </td>"
									+ "<td class='am-hide-sm-only'>" + "(" + item.endlon.substr(0, 8) + "," + item.endlat.substr(0, 8) + ") </td>"
									+ "<td class='am-hide-sm-only'>" + changeTime(item.starttime) + "</td>"
									+ "<td class='am-hide-sm-only'>" + changeTime(item.endtime) + "</td>"
									+ "<td class='am-hide-sm-only'>" + new AMap.LngLat(item.startlon, item.startlat).distance([ item.endlon, item.endlat ]) + "</td>"
									+ "<td><img src='assets/img/showtrace.png' height='20' width='20' alt='显示轨迹' data='" + item.id + "' onclick='showTrace($(this));'/></td></tr>";
								$("#usertbody").append(shtml);
							});
							showAllTrip();
						}
					});
			}
		</script>
		<script type="text/javascript">
			function GetRequest() {
				var url = location.search; //获取url中"?"符后的字串
				var theRequest = new Object();
				if (url.indexOf("?") != -1) {
					var str = url.substr(1);
					strs = str.split("&");
					for (var i = 0; i < strs.length; i++) {
						theRequest[strs[i].split("=")[0]] = decodeURIComponent(strs[i].split("=")[1]);
					}
				}
				return theRequest;
			}
		</script>

		<script type="text/javascript">
			var polyline;
			function showTrace(node) {
				$
					.ajax({
						url : "http://localhost:8080/easybike/restful/bike/getMobikeTripByTripId",
						type : "post",
						dataType : "json",
						data : {
							"tripid" : node
						},
						success : function(result) {
							var r = result;
							var obj = r.obj;
							var retcode = r.retcode;
							var errorMsg = r.errorMsg;
							if (retcode == "0001") {
								alert(errorMsg);
							} else {
								map.clearMap();
								var arr = new Array();
								arr.push(new AMap.LngLat(parseFloat(obj[0].startlon), parseFloat(obj[0].startlat)));
								arr.push(new AMap.LngLat(parseFloat(obj[0].endlon), parseFloat(obj[0].endlat)));
								map.setZoomAndCenter(18, arr[0]);
								var polyline = new AMap.Polyline({
									path : arr, //设置线覆盖物路径
									strokeColor : "#FF0000", //线颜色
									strokeOpacity : 1, //线透明度
									strokeWeight : 5, //线宽
									strokeStyle : "solid", //线样式
									strokeDasharray : [ 10, 5 ] //补充线样式
								});
								polyline.setMap(map);
							}
						}
					});
			}
		</script>

		<script type="text/javascript">
			function showAllTrip() {
				AMapUI.load([ 'ui/misc/PathSimplifier' ], function(PathSimplifier) {
		
					if (!PathSimplifier.supportCanvas) {
						alert('当前环境不支持 Canvas！');
						return;
					}
		
					var pathSimplifierIns = new PathSimplifier({
						zIndex : 100,
						map : map, //所属的地图实例
						getPath : function(pathData, pathIndex) {
							//返回轨迹数据中的节点信息，[AMap.LngLat, AMap.LngLat...] 或者 [[lng,lat],[lng,lat]...]
							return pathData.path;
						},
						getHoverTitle : function(pathData, pathIndex, pointIndex) {
							//返回鼠标悬停时显示的信息
							if (pointIndex >= 0) {
								//鼠标悬停在某个轨迹节点上
								return "";
							}
							//鼠标悬停在节点之间的连线上
							return "";
						},
						renderOptions : {
							//轨迹线的样式
							pathLineStyle : {
								strokeStyle : 'blue',
								lineWidth : 6,
								dirArrowStyle : true
							}
						}
					});
		
					//这里构建两条简单的轨迹，仅作示例
					pathSimplifierIns.setData([ {
						name : '轨迹1',
						path : trips
					} ]);
		
				});
			}
		</script>

		<script type="text/javascript">
		function changeTime(timestamp) {
			var newDate = new Date();
			newDate.setTime(timestamp);
			return newDate.toLocaleString();
		}
	</script>
</body>
</html>